<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini-Posts - Comparte tus ideas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- El contenedor de emojis se creará dinámicamente con JavaScript -->
    
    <main>
        <h1>Mini-Posts</h1>
        <p>El espacio donde tus ideas cobran vida. Comparte tus pensamientos con nuestra comunidad y descubre las ideas de otros. Pronto podrás conectar directamente con otros usuarios a través de nuestro chat privado.</p>

        <!-- Sección de Autenticación -->
        <section id="auth-section" class="hidden">
            <h2 id="auth-title">Iniciar Sesión</h2>
            <form id="auth-form">
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Contraseña" required>
                <button type="submit" id="auth-submit">Entrar</button>
            </form>
            <p id="toggle-auth">¿No tienes cuenta? Regístrate</p>
        </section>

        <!-- Sección de la App (para usuarios logueados) -->
        <section id="app-section" class="hidden">
            <div class="user-info">
                <span id="user-email"></span>
                <button id="logout-button">Cerrar Sesión</button>
            </div>

            <form id="post-form">
                <textarea id="post-content" placeholder="¿Qué estás pensando?" maxlength="200" required></textarea>
                <button type="submit">Publicar</button>
            </form>

            <div id="posts-container">
                <h2>Posts Recientes</h2>
                <div id="posts-list"></div>
            </div>
        </section>

    </main>

    <!-- SDK de Supabase (v1) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <!-- Script para el fondo animado -->
    <script src="src/animation/main_wallpaper.js"></script>

    <!-- Lógica ACL (expondrá window.__acl.manageAcl y getTokenV1) -->
    <script>
    // Versión en línea de src/logic/acl.js pero inyectada como script global para evitar configurar type="module".
    (function () {
      const SUPABASE_FUNCTION_URL = 'https://vicmgzclxyfjrlzgasqn.supabase.co/functions/v1/manage_acls';

      async function getTokenV1() {
        if (!window.supabase || !window.supabase.auth) return null;
        try {
          // SDK v1: session() es función que devuelve objeto { access_token, ... }
          const session = (typeof window.supabase.auth.session === 'function') ? window.supabase.auth.session() : null;
          return session?.access_token ?? null;
        } catch (e) {
          console.warn('getTokenV1 fallback error', e);
          return null;
        }
      }

      async function manageAcl({ action, target, id, user_id }) {
        if (!['add', 'remove'].includes(action)) throw new Error('Invalid action');
        if (!['wall', 'post'].includes(target)) throw new Error('Invalid target');
        if (!id) throw new Error('Missing id');
        if (!user_id) throw new Error('Missing user_id');

        const token = await getTokenV1();
        if (!token) {
          const err = new Error('Not authenticated');
          err.status = 401;
          throw err;
        }

        const res = await fetch(SUPABASE_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
          },
          body: JSON.stringify({ action, target, id, user_id }),
        });

        let payloadText;
        try { payloadText = await res.text(); } catch (_) { payloadText = null; }

        if (!res.ok) {
          let parsed = null;
          try { parsed = JSON.parse(payloadText); } catch (_) {}
          const message = parsed?.message || parsed?.error || payloadText || `HTTP ${res.status}`;
          const err = new Error(message);
          err.status = res.status;
          throw err;
        }

        try {
          return JSON.parse(payloadText);
        } catch (_) {
          return payloadText;
        }
      }

      // Exponer globalmente
      window.__acl = window.__acl || {};
      window.__acl.getTokenV1 = getTokenV1;
      window.__acl.manageAcl = manageAcl;
    })();
    </script>

    <!-- Nuestro script (app.js) debe gestionar TODO lo relativo a Supabase y al hash de auth) -->
    <script src="app.js"></script>
</body>
</html>
```__
