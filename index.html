<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini-Posts - Comparte tus ideas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- El contenedor de emojis se creará dinámicamente con JavaScript -->
    
    <main>
        <h1>Mini-Posts</h1>
        <p>El espacio donde tus ideas cobran vida. Comparte tus pensamientos con nuestra comunidad y descubre las ideas de otros. Pronto podrás conectar directamente con otros usuarios a través de nuestro chat privado.</p>

        <!-- Sección de Autenticación -->
        <section id="auth-section" class="hidden">
            <h2 id="auth-title">Iniciar Sesión</h2>
            <form id="auth-form">
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Contraseña" required>
                <button type="submit" id="auth-submit">Entrar</button>
            </form>
            <p id="toggle-auth">¿No tienes cuenta? Regístrate</p>
        </section>

        <!-- Sección de la App (para usuarios logueados) -->
        <section id="app-section" class="hidden">
            <div class="user-info">
                <span id="user-email"></span>
                <button id="logout-button">Cerrar Sesión</button>
            </div>

            <form id="post-form">
                <textarea id="post-content" placeholder="¿Qué estás pensando?" maxlength="200" required></textarea>
                <button type="submit">Publicar</button>
            </form>

            <div id="posts-container">
                <h2>Posts Recientes</h2>
                <div id="posts-list"></div>
            </div>
        </section>

    </main>

    <!-- SDK de Supabase (v1) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
      // Inicializa Supabase (coloca tus valores)
      const SUPABASE_URL = 'https://vicmgzclxyfjrlzgasqn.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpY21nemNseHlmanJsemdhc3FuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MDA5ODAsImV4cCI6MjA3ODM3Njk4MH0.CuCN5Zd-tGlSlMN0amFN4hh_LwCioVrL0RGse7r0oCo';
      const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      async function handleAuthRedirectAndClean() {
        try {
          // Si la URL contiene un fragmento con access_token, lo procesamos.
          if (window.location.hash && window.location.hash.includes('access_token')) {
            // supabase.auth.getSessionFromUrl() es una utilidad del v1 para procesar el hash.
            // La llamada devuelve { data: { session }, error }.
            const result = await supabase.auth.getSessionFromUrl({ storeSession: true });
            if (result.error) {
              console.warn('Error procesando sesión desde la URL:', result.error.message || result.error);
            } else {
              console.log('Sesion iniciada por redirect:', result.data?.session);
            }

            // Limpia el fragmento de la URL para que el token no quede visible.
            // Mantiene pathname y search (query params).
            history.replaceState(null, '', window.location.pathname + window.location.search);
          } else {
            // No hay fragmento; opcionalmente, recupera la sesión existente del storage
            const session = supabase.auth.session();
            if (session) {
              console.log('Sesion existente:', session);
            }
          }
        } catch (err) {
          console.error('Error en handleAuthRedirectAndClean:', err);
        }
      }

      // Ejecutar al inicio
      handleAuthRedirectAndClean();

      // Opcional: escucha cambios de auth
      supabase.auth.onAuthStateChange((event, session) => {
        console.log('Auth event:', event, session);
        // Maneja tu UI según el estado
        updateUI(session?.user ?? null);
      });
    </script>
    <!-- Script para el fondo animado -->
    <script src="src/animation/main_wallpaper.js"></script>
    <!-- Nuestro script -->
    <script src="app.js"></script>
</body>
</html>
